{% extends "base.html" %}

{% block title %}Grade {{ submission.student.username }}'s Work{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="mb-4">
                <h3>Grade Submission</h3>
                <p class="text-muted">{{ assignment.title }} - {{ submission.student.username }}</p>
            </div>

            <!-- Student Submission Content -->
            <div class="card mb-4" style="border-left: 4px solid #007bff;">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Student Submission</h6>
                </div>
                <div class="card-body">
                    {% if submission.content %}
                    <div class="submission-content bg-light p-3 rounded mb-3" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; font-size: 0.9em; line-height: 1.5;">
                        {{ submission.content }}
                    </div>
                    {% endif %}
                    
                    {% if submission.file_path %}
                    <div class="mt-3">
                        <a href="{{ submission.file_path }}" class="btn btn-outline-secondary btn-sm" target="_blank">
                            <i class="fas fa-download me-2"></i>Download Submission File
                        </a>
                    </div>
                    {% endif %}

                    <small class="text-muted d-block mt-3">
                        <i class="fas fa-clock me-1"></i>
                        Submitted: {{ submission.submitted_at.strftime('%B %d, %Y at %I:%M %p') }}
                    </small>
                </div>
            </div>

            <!-- Grading Form -->
            <form method="POST" id="gradingForm">
                {% if rubric %}
                <!-- Rubric-based Grading -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="fas fa-clipboard-list me-2"></i>
                            Rubric: {{ rubric.title }}
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-4">{{ rubric.description }}</p>

                        {% for criterion in rubric.criteria %}
                        <div class="criterion-section mb-4 pb-4 border-bottom">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <h6 class="mb-1">{{ criterion.name }}</h6>
                                    {% if criterion.description %}
                                    <small class="text-muted">{{ criterion.description }}</small>
                                    {% endif %}
                                </div>
                                <div class="col-md-4 text-end">
                                    <span class="badge bg-info">Max: {{ criterion.points }} pts</span>
                                </div>
                            </div>

                            <!-- Points Slider -->
                            <div class="mb-3">
                                <label class="form-label">Points Awarded</label>
                                <div class="input-group">
                                    <input type="range" 
                                        class="form-range criterion-slider" 
                                        id="criterion_{{ criterion.id }}" 
                                        name="criterion_{{ criterion.id }}" 
                                        min="0" 
                                        max="{{ criterion.points }}" 
                                        value="{{ grade_details.get(criterion.id).points_awarded if grade_details.get(criterion.id) else 0 }}"
                                        data-max="{{ criterion.points }}">
                                    <input type="number" 
                                        class="form-control" 
                                        style="width: 80px;" 
                                        id="criterion_input_{{ criterion.id }}" 
                                        name="criterion_input_{{ criterion.id }}"
                                        min="0" 
                                        max="{{ criterion.points }}" 
                                        value="{{ grade_details.get(criterion.id).points_awarded if grade_details.get(criterion.id) else 0 }}" 
                                        readonly>
                                    <span class="input-group-text">/ {{ criterion.points }}</span>
                                </div>
                            </div>

                            <!-- Notes -->
                            <div>
                                <label class="form-label">Notes (optional)</label>
                                <textarea class="form-control form-control-sm" 
                                    name="notes_{{ criterion.id }}" 
                                    rows="2" 
                                    placeholder="Add specific feedback for this criterion...">{% if grade_details.get(criterion.id) %}{{ grade_details.get(criterion.id).notes }}{% endif %}</textarea>
                            </div>
                        </div>
                        {% endfor %}

                        <div class="alert alert-info mt-4">
                            <strong>Total Points:</strong> 
                            <span id="totalPoints">0</span> / {{ rubric.total_points }}
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Simple Point-Based Grading -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Grade</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label"><strong>Total Points</strong></label>
                            <div class="input-group">
                                <input type="number" 
                                    class="form-control" 
                                    name="total_points" 
                                    min="0" 
                                    max="{{ assignment.max_points }}" 
                                    value="{{ submission.score if submission.score else 0 }}"
                                    id="totalPointsInput">
                                <span class="input-group-text">/ {{ assignment.max_points }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Feedback Section -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Feedback</h6>
                    </div>
                    <div class="card-body">
                        <textarea class="form-control" 
                            name="feedback" 
                            rows="5" 
                            placeholder="Provide constructive feedback for the student...">{% if submission.feedback %}{{ submission.feedback }}{% endif %}</textarea>
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-info-circle me-1"></i>
                            Be specific and encouraging. Help the student understand what they did well and what needs improvement.
                        </small>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="d-grid gap-2 d-sm-flex mb-4">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <i class="fas fa-check-circle me-2"></i>Submit Grade
                    </button>
                    <a href="{{ url_for('assignments.grading_dashboard', assignment_id=assignment.id) }}" class="btn btn-outline-secondary btn-lg">
                        <i class="fas fa-times-circle me-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Assignment Info -->
            <div class="card mb-4" style="border-left: 4px solid #6c757d;">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Assignment Details</h6>
                </div>
                <div class="card-body small">
                    <p><strong>Title:</strong> {{ assignment.title }}</p>
                    <p><strong>Max Points:</strong> {{ assignment.max_points }}</p>
                    <p><strong>Due Date:</strong> 
                        {% if assignment.due_date %}
                            {{ assignment.due_date.strftime('%m/%d/%Y') }}
                        {% else %}
                            No due date set
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Student Info -->
            <div class="card mb-4" style="border-left: 4px solid #0d6efd;">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Student Information</h6>
                </div>
                <div class="card-body small">
                    <p><strong>Name:</strong> {{ student.username }}</p>
                    <p><strong>Email:</strong> {{ student.email }}</p>
                    <p><strong>Submitted:</strong> 
                        {% if submission.submitted_at %}
                            {{ submission.submitted_at.strftime('%m/%d/%Y') }}
                        {% else %}
                            Not submitted
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- Grading Status -->
            <div class="card" style="border-left: 4px solid #198754;">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Status</h6>
                </div>
                <div class="card-body small">
                    {% if submission.graded %}
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Already Graded</strong>
                    </div>
                    <p><strong>Previous Score:</strong> {{ submission.score }}/{{ assignment.max_points }}</p>
                    <p><strong>Graded At:</strong> {{ submission.graded_at.strftime('%m/%d/%Y %I:%M %p') }}</p>
                    {% else %}
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-clock me-2"></i>
                        <strong>Not Yet Graded</strong>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Update point displays when sliders change
    document.querySelectorAll('.criterion-slider').forEach(slider => {
        slider.addEventListener('input', (e) => {
            const value = e.target.value;
            const inputId = e.target.id.replace('criterion_', 'criterion_input_');
            document.getElementById(inputId).value = value;
            updateTotalPoints();
        });
    });

    // Calculate total points
    function updateTotalPoints() {
        let total = 0;
        document.querySelectorAll('.criterion-slider').forEach(slider => {
            total += parseInt(slider.value) || 0;
        });
        document.getElementById('totalPoints').textContent = total;
    }

    // Initialize
    updateTotalPoints();

    // Handle form submission
    document.getElementById('gradingForm').addEventListener('submit', (e) => {
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting Grade...';
    });
});
</script>

<style>
    .criterion-section {
        background: #f8f9fa;
        padding: 1.5em;
        border-radius: 0.4em;
    }

    .form-range {
        height: 0.5rem;
    }

    .card {
        border-radius: 0.5em;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .submission-content {
        border: 1px solid #dee2e6;
    }

    @media (max-width: 768px) {
        .criterion-section {
            padding: 1em;
        }

        .btn-lg {
            padding: 0.5em 1em;
            font-size: 0.9em;
        }
    }
</style>
{% endblock %}
