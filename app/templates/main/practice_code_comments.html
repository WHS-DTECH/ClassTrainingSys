{% extends "base.html" %}

{% block title %}Practice: Code Comments Extractor{% endblock %}

{% block content %}
<div style="display: flex; flex-direction: row; gap: 2em; align-items: flex-start;">
    <div style="flex: 0 0 320px; min-width: 220px; max-width: 350px;">
        <div style="background:#f8fafd; border:2px solid #b3d1e6; border-radius:0.5em; padding:1.2em; margin-bottom:2em;">
            <h3 style="margin-top:0; color:#007bff; font-size:1.1em;">Your Checked Files</h3>
            {% if is_teacher %}
            <div style="font-size:0.98em; color:#555; margin-bottom:0.5em;">
                <em>This list shows only files <b>you</b> (the teacher) have checked. It is separate from student checked files.</em>
            </div>
            {% endif %}
            <table style="width:100%; border-collapse:collapse; font-size:1em;">
                <thead>
                    <tr style="background:#e3f2fd;">
                        <th style="padding:0.4em 0.5em; border-bottom:1px solid #b3d1e6; text-align:left;">Filename</th>
                        <th style="padding:0.4em 0.5em; border-bottom:1px solid #b3d1e6;">Comments Checker</th>
                        <th style="padding:0.4em 0.5em; border-bottom:1px solid #b3d1e6;">Debug Checker</th>
                    </tr>
                </thead>
                <tbody>
                {% for row in checked_files_grid %}
                    <tr>
                        <td style="padding:0.3em 0.5em; border-bottom:1px solid #e3f2fd;">{{ row.filename }}</td>
                        <td style="text-align:center;">{{ row.comment }}</td>
                        <td style="text-align:center;">{{ row.debug }}</td>
                    </tr>
                {% else %}
                    <tr><td colspan="3" style="text-align:center; color:#aaa;">No files checked yet.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div style="flex: 1 1 0; min-width: 0;">
        <div class="practice-comments-container" style="max-width:700px;margin:auto;">
    <h1>Practice: Paste Your Python Code</h1>


    <form method="post" enctype="multipart/form-data" id="uploadForm" style="margin-bottom:1em;">
        <div class="form-group">
            <label for="file">Or upload a Python file:</label>
            <input type="file" name="file" id="file" accept=".py" class="form-control-file">
            <button type="submit" class="btn" style="background: linear-gradient(90deg, #ff9800 60%, #ffc107 100%); color: #fff; font-weight: bold; border: none; border-radius: 0.5em; padding: 0.5em 1.2em; margin-top:0.5em;">Upload File</button>
            {% if uploaded_filename %}<span style="margin-left:1em; color:#888;">Uploaded: {{ uploaded_filename }}</span>{% endif %}
            {% if username %}<span style="margin-left:1em; color:#888;">User: {{ username }}</span>{% endif %}
        </div>
    </form>
    {% if upload_status %}
        <div style="margin-bottom:1em; color: {% if can_extract %}green{% else %}red{% endif %}; font-weight:bold;">{{ upload_status }}</div>
    {% endif %}
    {% if can_extract and uploaded_filename and not already_checked %}
        <form method="post" id="extractForm">
            <input type="hidden" name="uploaded_filename" value="{{ uploaded_filename }}">
            <input type="hidden" name="uploaded_code" value="{{ code|e }}">
            <input type="hidden" name="go_to_lesson" value="1">
            <button type="submit" name="extract_file" value="1" class="btn btn-success" style="font-weight:bold; border-radius:0.5em; padding:0.5em 1.2em;">Extract Comments from File</button>
        </form>
    {% endif %}

    {% if not username or (username and current_user.is_authenticated and current_user.is_teacher()) %}
    <form method="post" id="codeForm">
        <div class="form-group">
            <label for="code">Paste your Python code below:</label>
            <div style="margin-bottom: 0.5em;">
                <button type="submit" class="btn btn-primary">Submit</button>
                <button type="button" class="btn btn-secondary ml-2" id="clearBtn">Clear</button>
            </div>
            <textarea name="code" id="code" class="form-control" rows="12" required style="width:100%; min-width:100%; max-width:100%; box-sizing:border-box;">{{ code or '' }}</textarea>
        </div>
    </form>
    {% endif %}

    <div id="resultsSection" {% if not code or already_checked %}style="display:none;"{% endif %}>
        <hr>
        <div style="margin-bottom:1em;">
            {# Find the lesson with title 'Assessment Checking Overview' and link to it #}
            <!-- Button moved below code box, above comments box -->
        <h2>Your Code:</h2>
        <pre style="background:#f8f8f8; border:1px solid #ccc; padding:1em; border-radius:0.5em;">
            {%- set safe_code = code or '' -%}
            <div style="display: flex; flex-direction: column;">
            {%- for line in safe_code.splitlines() -%}
                <div style="display: flex; flex-direction: row;">
                    <span style="color:#888; min-width: 2.5em; text-align: right; user-select:none; padding-right:1em; border-right:1px solid #eee;">{{ loop.index }}</span>
                    <span style="padding-left:1em; white-space: pre;">{{ line }}</span>
                </div>
            {%- endfor -%}
            </div>
        </pre>
            <div style="margin: 1.5em 0 1em 0;">
                <form method="post" style="display:inline;">
                    <input type="hidden" name="code" value="{{ code|e }}">
                    <button type="submit" name="go_to_lesson" value="1" class="btn btn-info" style="background: linear-gradient(90deg, #007bff 60%, #00c6ff 100%); color: #fff; font-weight: bold; border: none; border-radius: 0.5em; padding: 0.7em 1.5em; font-size: 1.1em; text-decoration: none; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">Go to Lesson 1</button>
                </form>
            </div>
        <h2>Extracted Comments:</h2>
        {% if comment_lines %}
            <ul>
            {% for line_num, comment in comment_lines %}
                <li><strong>Line {{ line_num }}:</strong> <code>{{ comment }}</code></li>
            {% endfor %}
            </ul>
        {% else %}
            <p><em>No comments found in your code.</em></p>
        {% endif %}
    </div>
<script>
document.getElementById('clearBtn').addEventListener('click', function() {
    document.getElementById('code').value = '';
    var results = document.getElementById('resultsSection');
    if (results) {
        results.style.display = 'none';
    }
});
</script>
        </div>
    </div>
</div>
{% endblock %}
